<!DOCTYPE html>
<html>
  <title>Constellation Diagram</title>
<script src="https://d3js.org/d3.v4.js"></script>
<link rel="stylesheet" type="text/css" media="all" href="hlsi.css">
<script src=signal.js></script>
<script src=common.js></script>
<script src=label.js></script>
<script src=sliders.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>


<body>
<div id="modCodeSlider" style="margin-left: 1%; margin-top:8%; width: 100%;"></div>
<div id="noiseSlider" style="margin-left: 1%; margin-top:8%; width: 100%;"></div>



<!-- button legacy code  -->
<!-- <button onclick="buttonPressedAddPoints()">send message</button> -->

<button onclick="buttonPressedClearPoints()">clear message</button> 


<div id="my_dataviz"></div>

</body>

<script>



var sig = Signal(conf.sigIC_05, "", { bw_min: 4.0e6 });
var noise = Signal(conf.noiseIC_05, "Noise")
noise.gn = -60.0;
console.log(sig.mcs)
Slider(sig, 'mcs', null, "modCodeSlider");

// delcared for 16 qam as signal is also declared as 16 qam
let constellationTargets = [
                  { x: 1, y: 1 },
                  { x: 1, y: -1 },
                  { x: -1, y: 1 },
                  { x: -1, y: -1 },
              ];

    // set the dimensions and margins of the graph
    const margin = {top: 10, right: 30, bottom: 30, left: 60},
            width = 460 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    const svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);
    svg.append("rect")
    .attr("x",0)
    .attr("y",0)
    .attr("height", height )
    .attr("width", width )
    .style("fill", "EBEBEB")
        
    // Add X axis
    var x = d3.scaleLinear()
      .domain([-1.5, 1.5])
      .range([ -.001, width * 1.01 ]);
    svg.append("g")
      // sends the line to the bottom
      .attr("transform", "translate(0," + height + ")")
      // make grid lines
      .call(d3.axisBottom(x).tickSize(-height*1).ticks(7))

    // Add Y axis
    var y = d3.scaleLinear()
      .domain([-1.5, 1.5])
      .range([ height, 0]);
    svg.append("g")
      // make grid lines
      .call(d3.axisLeft(y).tickSize(-width*1).ticks(7))
      // stroke lines
      svg.selectAll(".tick line").attr("stroke", "#484848")

      // to draw the initial targets, will be overwritten when signal scheme is changed
  svg.append('g')
    .selectAll("dot")
    .data(constellationTargets)
    .enter()
    .append("circle")
      .attr("cx", function (d) { return x(d.x); } )
      .attr("cy", function (d) { return y(d.y); } )
      .attr("r", 1.5)
      .style("fill","#00FF00")


    // console.log(sig)
    Slider(noise, 'gn', null, "noiseSlider");
    Label(sig, 'sinr', {
    prefix: "Signal-to-Noise Ratio: SNR = "
    }, "noiseSlider");

  // console.log(sig.sinr)

  // START OF LOOPING CODE
  let counter = 0;
  setInterval(() => {
  // console.log("1 second has passed");
  const ebno = math.log10(math.abs(sig.sinr))
  // console.log(ebno);
    counter = counter + 1;
    if (counter == 9){
      counter = 0;
      d3.select("#my_dataviz").selectAll("circle").remove();
      regenerateConstellationTargets();
      // console.log("10 seconds has passed")
    }
  for (let i = 0; i < 24; i++) {
    svg.append('g')
    .selectAll("dot")
    .data(constellationTargets)
    .enter()
    .append("circle")
      .attr("cx", function (d) { 
        // console.log(d.x + randn_bm() * (1/ebno)**2)
        // creates a variable that can be edited if it goes out of bounds for x and y values
        let xVal = d.x + randn_bm() * (1/ebno)**2;
        if (xVal> 1.5){
          xVal = 1.5 
        } else if(xVal < -1.5){
          xVal = -1.5
        }
        return x(xVal); } )
      .attr("cy", function (d) { 
        let yVal = d.y + randn_bm() * (1/ebno)**2;
        if (yVal> 1.5){
          yVal = 1.5
        } else if (yVal < -1.5){
          yVal = -1.5
        }
        return y(yVal); } )
      .attr("r", 1.5)
      .style("fill","#FF0000")
      regenerateConstellationTargets();
    }
    // value below is the loop time in miliseconds
}, 1000);


sig.onChange("mcs", update_constellation);

function update_constellation(){
  console.log(sig.mcs)
  console.log("The modulation code has changed")

  if(sig.mcs>2 && sig.mcs <5 ){
  constellationTargets = [
                  { x: 1, y: 1 },
                  { x: 1, y: -1 },
                  { x: -1, y: 1 },
                  { x: -1, y: -1 },
              ];
} else if(sig.mcs <2){
  console.log(sig.mcs)
  console.log("switching to BPSK")
  constellationTargets = [
                  { x: 1, y: 0 },
                  { x: -1, y: 0 },
              ];
} else if (sig.mcs >=5 && sig.mcs <7 ){
  console.log("16 qam");


  constellationTargets = [ { x: -1.000, y: -1.000 }, { x: -1.000, y: -0.333 }, { x: -1.000, y: 0.333 }, { x: -1.000, y: 1.000 }, { x: -0.333, y: -1.000 }, { x: -0.333, y: -0.333 }, { x: -0.333, y: 0.333 }, { x: -0.333, y: 1.000 }, { x: 0.333, y: -1.000 }, { x: 0.333, y: -0.333 }, { x: 0.333, y: 0.333 }, { x: 0.333, y: 1.000 }, { x: 1.000, y: -1.000 }, { x: 1.000, y: -0.333 }, { x: 1.000, y: 0.333 }, { x: 1.000, y: 1.000 } ];

} else if (sig.mcs == 7){
 console.log("32 qam");
 // TODO: finish making this

}
// delete all dots
d3.select("#my_dataviz").selectAll("circle").remove();

regenerateConstellationTargets();

}
//////////////////////////////////
// buttons 
  // adds the ability to manually send message via buttons
  function buttonPressedAddPoints(){
    // console.log(sig.sinr)

      // Add dots
  const randData = [
                { x: 1, y: 1 },
                { x: 1, y: -1 },
                { x: -1, y: 1 },
                { x: -1, y: -1 },
            ];
  const ebno = math.log10(math.abs(sig.sinr))
  console.log(ebno);
    for (let i = 0; i < 24; i++) {

    svg.append('g')
    .selectAll("dot")
    .data(randData)
    .enter()
    .append("circle")
      .attr("cx", function (d) { return x(d.x + randn_bm() * (1/ebno)**2); } )
      .attr("cy", function (d) { return y(d.y + randn_bm() * (1/ebno)**2); } )
      .attr("r", 1.5)
      .style("fill","#FF0000")
      // console.log("button pressed")
  }

}
 // use the clear all circles button
function buttonPressedClearPoints(){
  d3.select("#my_dataviz").selectAll("circle").remove();


}



///////////////////
// helper functions
function regenerateConstellationTargets(){
  svg.append('g')
    .selectAll("dot")
    .data(constellationTargets)
    .enter()
    .append("circle")
      .attr("cx", function (d) { return x(d.x); } )
      .attr("cy", function (d) { return y(d.y); } )
      .attr("r", 1.5)
      .style("fill","#00FF00")
}
function randn_bm() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
    while(v === 0) v = Math.random();
    let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
    num = num / 10.0 + 0.5; // Translate to 0 -> 1
    if (num > 1 || num < 0) return randn_bm() // resample between 0 and 1
     num = num - 0.5; // added to center around 0
    return num
  }


</script>

</html>